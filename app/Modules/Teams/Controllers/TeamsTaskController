<?php

namespace App\Modules\Teams\Controllers;

use App\Http\Controllers\Controller;
use App\Modules\Teams\Models\TeamsTask;
use App\Modules\Teams\Requests\StoreTeamsTaskRequest;
use App\Modules\Teams\Requests\UpdateTeamsTaskRequest;
use App\Modules\Teams\Services\TeamsTaskService;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class TeamsTaskController extends Controller
{
    public function __construct(
        private TeamsTaskService $teamsTaskService
    ) {}

    public function index(Request $request, int $taskId): JsonResponse
    {
        $teams = $this->teamsTaskService->getTaskTeams($taskId, $request->all());

        return response()->json([
            'message' => 'Teams retrieved successfully',
            'data' => $teams
        ]);
    }

    public function store(StoreTeamsTaskRequest $request, int $taskId): JsonResponse
    {
        $teamTask = $this->teamsTaskService->createTeamTask($taskId, $request->validated());

        return response()->json([
            'message' => 'Team task created successfully',
            'data' => $teamTask
        ], 201);
    }

    public function update(UpdateTeamsTaskRequest $request, int $taskId, int $teamTaskId): JsonResponse
    {
        $teamTask = $this->teamsTaskService->updateTeamTask($teamTaskId, $request->validated());

        return response()->json([
            'message' => 'Team task updated successfully',
            'data' => $teamTask
        ]);
    }

    public function destroy(int $taskId, int $teamTaskId): JsonResponse
    {
        $this->teamsTaskService->deleteTeamTask($teamTaskId);

        return response()->json([
            'message' => 'Team task deleted successfully'
        ]);
    }

    public function bulkAssign(Request $request, int $taskId): JsonResponse
    {
        $this->validate($request, [
            'assignments' => 'required|array',
            'assignments.*.category_id' => 'required|exists:team_categories,id',
            'assignments.*.team_type_id' => 'required|exists:team_types,id',
            'assignments.*.required_members' => 'required|integer|min:1',
            'assignments.*.members' => 'array'
        ]);

        $results = $this->teamsTaskService->bulkAssignTeams($taskId, $request->assignments);

        return response()->json([
            'message' => 'Bulk team assignment completed',
            'data' => $results
        ]);
    }
}